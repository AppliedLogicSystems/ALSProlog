# Generic GNU Make file for ALS Prolog
ALSDEVDIR=$(CORE)/als_dev/alsdev
CORE=$(SOURCE_DIR)/..
ALS_BUILD_SUPPORT = /apache/als_build_support/unix
VPATH = $(SOURCE_DIR)/$(OS):$(SOURCE_DIR)/generic:$(SOURCE_DIR)/$(PROC):$(SOURCE_DIR)/smath:$(SOURCE_DIR)/builtins:$(SOURCE_DIR)/library:$(ALSDEVDIR):$(CORE)/tcltk_interface/common


default : binaries

MAKEFS = Makefile gnu_makefile $(OS)_makefile $(CCOMP)_makefile

ifndef CCOMP
CCOMP=gcc
endif

CPPFLAGS = $(BUILD_FLAGS) \
	-I $(SOURCE_DIR)/$(PROC) \
	-I $(SOURCE_DIR)/$(OS) \
	-I $(SOURCE_DIR)/generic \
	-I $(SOURCE_DIR)/smath \
	-isystem $(ALS_BUILD_SUPPORT)/include

MAIN_SOURCE = topmain.c

MAIN_OBJECTS = $(MAIN_SOURCE:.c=.o)

ALSDEV_SOURCE = unix_alsdev.c tcl_interface.c

ALSDEV_OBJECTS = $(ALSDEV_SOURCE:.c=.o)

GENERIC_SOURCE = alloc.c arith.c random.c bcinter.c bdb.c \
	bdbg.c bgv.c bio.c bmeta.c \
	bmisc.c bos.c bparser.c bpckg.c \
	bsio.c bsystem.c built.c butil.c \
	cinterf.c compile.c compmath.c cutmacro.c \
	debugsys.c expand.c fatal.c fileio.c \
	foreign.c fpbasis.c freeze.c gc.c \
	gv.c index.c intaux.c intrv.c \
	int_net.c lexan.c lforeign.c loadfile.c \
	main.c mapsym.c mem.c \
	module.c parser.c pckgcoff.c pckgload.c \
	pckgmake.c rinfo.c sig.c symtab.c \
	varproc.c vprintf.c wdisp.c wintcode.c \
	winter.c security.c nopckg.c \
	ieeemath.c pimain.c new_alspi.c engine.c \
	relocate_code.c cexception.c cassert.c demo.c

LIB_SOURCE = $(GENERIC_SOURCE) $(PROC_SOURCE) $(OS_SOURCE)

LIB_OBJECTS = $(LIB_SOURCE:.c=.o)

BUILTINS =       blt_frez.pro  blt_std.pro   filepath.pro  ra_basis.pro \
   blt_als.pro   blt_io.pro    blt_stk.pro   fs_cmn.pro    simplio.pro \
   blt_atom.pro  blt_is.pro    blt_sys.pro   fsdos.pro     sio.pro \
   blt_brk.pro   blt_lib.pro   blt_term.pro  fsmac.pro     sio_d10.pro \
   blt_cslt.pro  blt_misc.pro  builtins.pro  fsunix.pro    sio_rt.pro \
   blt_ctl.pro   blt_msg.pro   comp_d10.pro  fswin32.pro   sio_wt.pro \
   blt_db.pro    blt_pckg.pro  cutils.pro    int_cstr.pro  xconsult.pro \
   blt_evt.pro   blt_shl.pro   dcgs.pro      math88k.pro \
   blt_flgs.pro  blt_shlr.pro  debugger.pro  module.pro \
   blt_shlc.pro  objs_run.pro  shlclass.pro  tc_base.pro

# OS and Proccessor definitions and rules

include $(SOURCE_DIR)/$(OS)/$(OS)_makefile
include $(SOURCE_DIR)/$(PROC)/$(PROC)_makefile
include $(SOURCE_DIR)/$(OS)/$(CCOMP)_makefile

# Generic rules

$(MAIN_OBJECTS) : $(MAKEFS)

$(LIB_OBJECTS) $(STATIC_OBJECTS) $(SHARED_OBJECTS) : $(MAKEFS)

binaries : alspro_b libalspro.a libalspro.$(OS_SL_EXT) alspro alsdev \
			studalsdev alsdev_demo alspro_demo

all : default

alspro_b : alsdir $(MAIN_OBJECTS) libalspro.a $(MAKEFS)
	$(CC) -o alspro_b $(MAIN_OBJECTS) libalspro.a $(LIBS)

alspro :  alsdir alspro_b $(BUILTINS) $(MAKEFS)
	rm -f alsdir/builtins/*.obp
	rm -f alsdir/library/*.obp
	./alspro_b -q -b -obp $(ALSDEVDIR)/ldr_alspro.pro -g 'save_image(alspro,[])'

ifndef NO_STATIC_LIB
libalspro.a : alsdir $(STATIC_OBJECTS) $(LIB_OBJECTS) $(MAKEFS)
	$(OS_AR) libalspro.a $(STATIC_OBJECTS) $(LIB_OBJECTS)
	$(OS_RANLIB) libalspro.a
endif

libalspro.$(OS_SL_EXT) : alspro_b alsdir  $(SHARED_OBJECTS) $(LIB_OBJECTS) $(MAKEFS)
	$(OS_SL_LINK) -o libalspro.$(OS_SL_EXT) $(SHARED_OBJECTS) \
	    $(LIB_OBJECTS) $(SL_LINK_LIBS)
	./alspro_b -q -b -obp -g "attach_image('libalspro.$(OS_SL_EXT)')"

so_test : libalspro.$(OS_SL_EXT) $(MAKEFS)
	$(CC) -o so_test $(MAIN_OBJECTS) libalspro.so $(LIB)

alsdir : alsdir/builtins alsdir/library

alsdir/builtins : $(SOURCE_DIR)/builtins $(MAKEFS)
	mkdir -p alsdir/builtins
	rm -f alsdir/builtins/*.pro
	cd alsdir/builtins ; ln -s ../../$(SOURCE_DIR)/builtins/*.pro .

alsdir/library : $(SOURCE_DIR)/library $(MAKEFS)
	mkdir -p alsdir/library
	rm -f alsdir/library/*.pro alsdir/library/*.alb
	cd alsdir/library ; ln -s ../../$(SOURCE_DIR)/library/*.pro .
	cd alsdir/library ; ln -s ../../$(SOURCE_DIR)/library/*.alb .

alsdir/shared : $(MAKEFS)
	mkdir -p alsdir/shared
	rm -f alsdir/shared/*.pro alsdir/shared/*.psl alsdir/shared/*.tcl
	cd alsdir/shared ; ln -s ../../$(CORE)/als_dev/alsdev/*.tcl .
				 
alsdir/images : $(CORE)/als_dev/alsdev $(MAKEFS)
	mkdir -p alsdir/images
	rm -f alsdir/images/*.*
	cd alsdir/images ; ln -s ../../$(CORE)/als_dev/alsdev/images/*.gif .

TEST_DIR = $(SOURCE_DIR)/tests

test: testrun

testrun : command_line_test iso_test_suite test_suite

command_line_test: alspro
	-sh $(TEST_DIR)/tsuite/test_command_line.sh ./alspro

test_suite: alspro
	./alspro -giac -b $(TEST_DIR)/autotest.pro $(TEST_DIR)/atest_db.pro -g run_tests -p -srcdir $(SOURCE_DIR)

iso_test_suite: alspro
	./alspro -giac -b $(TEST_DIR)/iso_test_suite/valid_so.pro -g "cd('$(TEST_DIR)/iso_test_suite'), run_all_tests."

#	./alspro -giac -b $(TEST_DIR)/iso_test_suite/valid_so.pro $(TEST_DIR)/iso_test_suite/utils_so.pro -g "cd('$(TEST_DIR)/iso_test_suite'), run_all_tests."

ALSDEVFILES = blt_dvsh.pro dbg_class.pro projects.pro
ALSDEVLIBS=listutl1,misc_db,miscterm,msc_ioin,mscioout,strctutl,strings,tcl_sppt,tk_alslib,typecomp
ALSDEVLIBPS =listutl1.pro misc_db.pro miscterm.pro msc_ioin.pro mscioout.pro strctutl.pro \
			strings.pro tcl_sppt.pro tk_alslib.pro typecomp.pro

GETDIR=$(CORE)/als_dev/alsdev/getDirectory
GETFILES=$(CORE)/als_dev/alsdev/getFiles
ALSDEVDIR=$(CORE)/als_dev/alsdev
DEMOFILES=$(ALSDEVDIR)/demo15.pro $(ALSDEVDIR)/serial_cmn.pro $(ALSDEVDIR)/ldr_dvsh.pro

lib: $(GETDIR)/getDirectory.tcl $(GETDIR)/unix_pkgIndex.tcl $(GETFILES)/getFiles.tcl $(GETFILES)/unix_pkgIndex.tcl $(MAKEFS)
	cp -r $(ALS_BUILD_SUPPORT)/lib .
	chmod -R +w lib
	mkdir -p lib/tk8.0/getDirectory
	cp -r $(GETDIR)/getDirectory.tcl lib/tk8.0/getDirectory
	cp -r $(GETDIR)/unix_pkgIndex.tcl lib/tk8.0/getDirectory/pkgIndex.tcl
	mkdir -p lib/tk8.0/getFiles
	cp -r $(GETFILES)/getFiles.tcl lib/tk8.0/getFiles
	cp -r $(GETFILES)/unix_pkgIndex.tcl lib/tk8.0/getFiles/pkgIndex.tcl

ALSDEV_LIBS = -litcl3.0 -litk3.0 -ltcl8.0 -ltk8.0

alsdev_b : libalspro.a $(ALSDEV_OBJECTS) $(MAKEFS)
	$(CC) $(CFLAGS) -o alsdev_b  $(ALSDEV_OBJECTS) libalspro.a $(LIBS) -L$(ALS_BUILD_SUPPORT)/$(SUBOS)/lib -litcl3.0 -litk3.0 -ltcl8.0 -ltk8.0 -lX11


alsdev :  alsdev_b alsdir alsdir/images alsdir/shared $(BUILTINS) $(ALSDEVFILES) $(ALSDEVLIBPS) lib $(MAKEFS)
	rm -f alsdir/builtins/*.obp
	rm -f alsdir/library/*.obp
	rm -f $(SUBOS)/*.obp
	rm -f *.obp
	./alsdev_b -q -b -obp -no_dot_alspro $(ALSDEVDIR)/ldr_alsdev.pro -g "bldit('$(CORE)',save_image(alsdev,[start_goal((builtins:start_alsdev))]))"


studalsdev :  alsdev_b alsdir alsdir/images alsdir/shared $(BUILTINS) $(ALSDEVFILES) $(ALSDEVLIBPS) lib $(MAKEFS)
	rm -f alsdir/builtins/*.obp
	rm -f alsdir/library/*.obp
	rm -f $(SUBOS)/*.obp
	rm -f *.obp
	./alsdev_b -q -b -obp -no_dot_alspro \
	$(ALSDEVDIR)/ldr_studalsdev.pro -g "bldit('$(CORE)',save_image(studalsdev,[start_goal((builtins:start_alsdev))]))"



#	alsdir/shared/tcltk_util \
#	-g 'builtins:abolish(save_image,1), \
#	sio:abolish(open_socket_stream,4), \
#	save_image(studalsdev,[start_goal((builtins:start_alsdev)), \
#	select_lib(builtins, [blt_dvsh,dbg_class,projects]), \
#	select_lib(library,[$(ALSDEVLIBS)])])'

alsdev_demo :  alsdev_b alsdir alsdir/images alsdir/shared $(BUILTINS) $(ALSDEVFILES) $(ALSDEVLIBPS) lib $(MAKEFS)
	rm -f alsdir/builtins/*.obp
	rm -f alsdir/library/*.obp
	rm -f $(SUBOS)/*.obp
	rm -f *.obp
	rm -f ../../als_dev/alsdev/demo15.obp
	rm -f ../../als_dev/alsdev/serial_cmn.obp
	./alsdev_b -q -b -obp -no_dot_alspro $(ALSDEVDIR)/ldr_alsdev_demo.pro -g "bldit('$(CORE)',save_image(alsdev_demo,[start_goal((builtins:start_alsdev))]))"


#	./alspro_b -q -b -obp -no_dot_alspro $(ALSDEVDIR)/ldr_alsdev_demo.pro -g 'save_image(alsdev_demo,[start_goal((builtins:start_alsdev))])'


alspro_demo :  alsdir alspro_b $(BUILTINS) $(MAKEFS) $(DEMOFILES)
	rm -f alsdir/builtins/*.obp
	rm -f alsdir/library/*.obp
	rm -f $(SUBOS)/*.obp
	rm -f *.obp
	./alspro_b -q -b -obp $(ALSDEVDIR)/ldr_alspro_demo.pro -g "bldit('$(CORE)',save_image(alspro_demo,[]))"

#	./alspro_b -q -b -obp $(ALSDEVDIR)/ldr_alspro_demo.pro -g 'save_image(alspro_demo,[])'


clean :
	rm -f *.o rm *.d

distclean: superclean

superclean : clean
	rm -fr alsdir alspro* alspro_b* alsdev* studals* libalspro.a libalspro.$(OS_SL_EXT)* *.obp $(SUBOS) lib

-include *.d

